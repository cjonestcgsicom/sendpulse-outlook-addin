!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=1)}([function(e,t,o){"use strict";o.r(t),o.d(t,"SendPulseClient",function(){return n});var n=function(){function e(e,t,o){this.clientID="",this.clientSecret="",this.token="",this.baseURL="",this.clientID=e,this.clientSecret=t,this.token="",this.baseURL=o}return e.prototype.getToken=function(e){var t={grant_type:"client_credentials",client_id:this.clientID,client_secret:this.clientSecret};this.makeRequest(t,"POST",this.baseURL+"sendpulsetoken",!1,e)},e.prototype.getAddressBooks=function(e){this.token=localStorage.getItem("sendPulseToken");var t={url:"listAddressBooks",token:this.token};this.makeRequest(t,"POST",this.baseURL+"sendpulse",!0,e)},e.prototype.getAddressBookContacts=function(e,t){this.token=localStorage.getItem("sendPulseToken");var o={url:"getEmailsFromBook",id:e,token:this.token};this.makeRequest(o,"POST",this.baseURL+"sendpulse",!0,t)},e.prototype.addEmailsToAddressBook=function(e,t,o){this.token=localStorage.getItem("sendPulseToken");var n={url:"addEmails",id:e,emails:t,token:this.token};this.makeRequest(n,"POST",this.baseURL+"sendpulse",!0,o)},e.prototype.makeRequest=function(e,t,o,n,r){var s=this,i=new XMLHttpRequest;i.open(t,o,!0),i.setRequestHeader("Content-Type","application/json"),n&&i.setRequestHeader("Authorization","Bearer "+this.token),i.send(JSON.stringify(e)),i.addEventListener("load",function(e){var t=JSON.parse(i.responseText);console.log("Response: "+JSON.stringify(t)),null!==t.access_token?(console.log("Token: "+t.access_token),s.token=t.access_token):console.log("Auth error: "+JSON.stringify(t)),r(t)})},e}()},function(e,t,o){"use strict";o.r(t);var n=o(0),r=function(e,t,o,n){return new(o||(o=Promise))(function(r,s){function i(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(i,a)}l((n=n.apply(e,t||[])).next())})},s=function(e,t){var o,n,r,s,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(o)throw new TypeError("Generator is already executing.");for(;i;)try{if(o=1,n&&(r=n[2&s[0]?"return":s[0]?"throw":"next"])&&!(r=r.call(n,s[1])).done)return r;switch(n=0,r&&(s=[0,r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=(r=i.trys).length>0&&r[r.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{o=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};$(document).ready(function(){$("#run").hide(),$("#run").click(function(){return r(this,void 0,void 0,function(){var e;return s(this,function(t){return null===localStorage.getItem("microsoftToken")||void 0===localStorage.getItem("microsoftToken")?g():(console.log("Token we got: "+localStorage.getItem("microsoftToken")),e=$("#foldersList").val(),a=i[e],console.log("ContactFolder selected: "+e),function(e,t,n){$("#syncBtnTitle").html("Getting Outlook Folder Contacts..."),$("#run").hide(),$("#spinner").show(),$.ajax({url:"https://graph.microsoft.com/v1.0/me/contactfolders/"+t.id+"/contacts",dataType:"json",headers:{Authorization:"Bearer "+e}}).done(function(e){console.log("Contacts: "+JSON.stringify(e)),o=e.value,n(!0),$("#syncBtnTitle").html("Synchronize"),$("#run").show(),$("#spinner").hide()}).fail(function(e){$("#spinner").hide(),console.log("Error: "+JSON.stringify(e)),n(!1),e.status&&($("#syncBtnTitle").html("Refresh Outlook Folders"),200!=e.status&&g())})}(localStorage.getItem("microsoftToken"),a,function(e){o.length>0?localStorage.setItem("selectedMicrosoftContacts",JSON.stringify(o)):console.log("No contacts selected to sync!"),e&&function(){var e=localStorage.getItem("bookID"),t=o,r=JSON.parse(localStorage.getItem("emailsSelected")),s=localStorage.getItem("masterMode");if("2"===s){if(!Array.isArray(t)||0===t.length)return void y("You don't have any Outlook contacts to eÑ…port from selected folder!");$("#spinner").show(),$("#run").hide(),$("#progress_dynamics").show(),d=t.length,f=0;var i=[];t.forEach(function(e,t){e.emailAddresses.forEach(function(t){if(t.address){console.log("Outlook contact email : "+JSON.stringify(t.address.toLowerCase()));var o={email:t.address.toLowerCase(),variables:{firstName:"",lastName:""}};e.givenName&&(o.variables.firstName=e.givenName),e.surname&&(o.variables.lastName=e.surname),i.push(o)}}),v()});var h=new n.SendPulseClient(c,u,l);h.addEmailsToAddressBook(e,i,function(e){$("#spinner").hide(),$("#progress_dynamics").hide(),$("#run").show(),e.error?y(e.message?e.message:e.error_description):console.log("added contacts to sendpulse: ",i.length)})}else if("1"===s){if(console.log("Export from SendPulse"),!Array.isArray(r)||0===r.length)return void y("You don't have any SendPulse emails to import!");$("#spinner").show(),$("#run").hide(),$("#progress_dynamics").show(),d=r.length,f=0,r.forEach(function(e){var o={GivenName:e.email.split("@")[0],EmailAddresses:[{Address:e.email,Name:e.email.split("@")[0]}]};e.variables&&(e.variables.firstName&&(o.GivenName=e.variables.firstName),e.variables.lastName&&(o.surname=e.variables.lastName)),t.forEach(function(t){(function(e,t){var o=!1;return t.emailAddresses.forEach(function(t){if(t.address&&e.email&&t.address.toLowerCase()===e.email.toLowerCase())return o=!0,console.log("Outlook contact email : "+JSON.stringify(t.address.toLowerCase())),console.log("SP Contact email: "+e.Email.toLowerCase()),!0}),o})(e,t)&&(o=null)}),null!=o&&function(e,t,o,n){$.ajax({url:"https://graph.microsoft.com/v1.0/me/contactfolders/"+t.id+"/contacts",type:"POST",contentType:"application/json",data:JSON.stringify(o),headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"}}).done(function(e){console.log("Contact created: "+JSON.stringify(e)),n(!0)}).fail(function(e){console.log("Error: "+JSON.stringify(e)),n(!1),e.status&&e.status})}(localStorage.getItem("microsoftToken"),a,o,function(e){console.log(e),v()})})}}()})),[2]})})});var e,t=t||{},o=[],i=[],a={},l=localStorage.getItem("baseURL"),c=localStorage.getItem("sendPulseID")||"",u=localStorage.getItem("sendPulseSecret")||"",d=0,f=0;function h(){var e;null===localStorage.getItem("microsoftToken")||void 0===localStorage.getItem("microsoftToken")?(console.log("Still not authorized with Microsoft account"),g()):(console.log("Token we got: "+localStorage.getItem("microsoftToken")),e=localStorage.getItem("microsoftToken"),$("#run").hide(),$("#spinner").show(),$.ajax({url:"https://graph.microsoft.com/beta/me/contactFolders",dataType:"json",headers:{Authorization:"Bearer "+e}}).done(function(e){console.log("Folders: "+JSON.stringify(e)),i=e.value,$("#sync_div").show(),$("#foldersList").empty(),Array.isArray(i)&&i.length>0&&i.forEach(function(e,t){var o="<option "+(0==t?"selected":"")+'  value="'+t+'">'+e.displayName+"</option>";$("#foldersList").append(o)}),$("#run").show(),$("#spinner").hide()}).fail(function(e){$("#spinner").hide(),console.log("Error: "+JSON.stringify(e)),e.status&&($("#syncBtnTitle").html("Select Outlook Folders"),200!=e.status&&g())}))}function g(){var t=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+"/popup.html";Office.context.ui.displayDialogAsync(t,{height:45,width:55},function(t){(e=t.value).addEventHandler(Office.EventType.DialogMessageReceived,m),e.addEventHandler(Office.EventType.DialogEventReceived,p)})}function m(t){var o=JSON.parse(t.message);console.log("Dialog sent a message: "+JSON.stringify(o)),"success"===o?(e.close(),console.log("Auth2 response: "+JSON.stringify(o))):(e.close(),console.error("User authentication and application authorization","Unable to successfully authenticate user or authorize application: "+o.error))}function p(e){switch(e.error){case 12002:console.error("Cannot load URL, no such page or bad URL syntax.");break;case 12003:console.error("HTTPS is required.");break;case 12006:console.log("Dialog closed by user"),h();break;default:h(),console.error("Undefined error in dialog window")}}function y(e){$(".alert").show(),$("#error_text").html(e)}function v(){f+=1,console.log("Counter: "+f+" out of "+d);var e=Math.ceil(100*f/(1*d));console.log("Progress: "+e),$("#dynamic").css("width",e+"%").attr("aria-valuenow",e).text(e+"% Complete"),f==d&&($("#spinner").hide(),$("#run").show(),$("#progress_dynamics").hide())}t.secret="nnoHKD75!)gwzrSICW728?[",t.clientID="c80d93b6-a45b-405c-add9-388a25beadb9",localStorage.setItem("clientID",t.clientID),localStorage.setItem("secret",t.secret),localStorage.setItem("redirectURI",l+"function-file/function-file.html"),localStorage.removeItem("selectedMicrosoftContacts"),$("#sideload-msg").hide(),$(".alert").hide(),$("#progress_dynamics").hide(),$("#sync_div").hide(),$("#spinner").hide(),$("#app-body").show(),$("#run").hide(),$(".close").click(function(e){$(".alert").hide()}),$("[data-dismiss]").click(function(e){$(".alert").hide()}),h(),Office.initialize=function(e){}})}]);